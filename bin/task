#!/bin/bash

ENV_BEFORE=$(env)

export TASK_NAME="$1"
export TASK_LIBRARY_ROOT="./node_modules/task-library"
export TASK_LIBRARY_SRC="$TASK_LIBRARY_ROOT/src"
export TASK_LIBRARY_LIB="$TASK_LIBRARY_SRC/lib"
export TASK_LIBRARY_NODE_TASKS="$TASK_LIBRARY_SRC/node-tasks"
export TASK_LIBRARY_TASKS="$TASK_LIBRARY_SRC/tasks"

. $TASK_LIBRARY_SRC/load-task-vars

ENV_AFTER=$(env)

if [ "$TASK_NAME" = "vars" ]; then
    sort <(echo "$ENV_BEFORE" ) <(echo "$ENV_AFTER") | uniq -u
    exit
fi

TASK_FILE=$(taskfile $TASK_NAME)
[ -z "$TASK_FILE" ] && echo "Task \"$TASK_NAME\" not found." && exit 1
chmod +x "$TASK_FILE"
echo "âš¡ï¸ Task \"$TASK_NAME\" started. Source: $TASK_FILE"
START=$(nowInMs)
"$TASK_FILE" "${@:2}"
EXIT_CODE=$?
END=$(nowInMs)
echo "ðŸ Task \"$TASK_NAME\" completed with exit code $EXIT_CODE in $((END-START)) ms."
exit $EXIT_CODE
