#!/bin/bash

export STAGE=${STAGE:-"local"}
export TASK_LIBRARY_ROOT="./node_modules/task-library"

function export_functions {
    script="$1"
    funcs=$(extract_function_names "$script")
    source "$script"
    while IFS= read -r name; do
        export -f "$name"
    done <<< "$funcs"
}

function extract_function_names {
    script="$1"
    pattern="function (.+) "
    while IFS= read -r line; do
        [[ $line =~ $pattern ]] && echo "${BASH_REMATCH[1]}"
    done < "$script"
}

export_functions "$TASK_LIBRARY_ROOT/src/lib-functions"
export_functions "$TASK_LIBRARY_ROOT/src/var-functions"
task "$@"
