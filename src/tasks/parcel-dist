#!/bin/bash
  
parcel_command="${1:-build}"
[ "$parcel_command" = "build" ] && base_path="$WEB_BASE_PATH"
[ -z "$base_path" ] && base_path="/"

npx task code-gen
npx task index-html-gen

rm -rf "$DIST"
mkdir -p "$DIST"
cp -a "$STATIC/" "$DIST"

package_source=$(package "source")
package_targets=$(package "targets")

[ -z "$package_source" ] && [ -z "$package_targets" ] && source="$INDEX_HTML" || source=""

NO_BABEL_CONFIG="true" \
npx parcel "$parcel_command" \
    "$source" \
    --public-url "$base_path" \
    --dist-dir "$DIST"
